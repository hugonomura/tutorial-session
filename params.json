{"name":"Utilizando Session em JSP","tagline":"Tutorial usando Session em JSP","body":"## A funcionalidade\r\nNesse tutorial iremos efetivamente criar a funcionalidade de login e, para isso, iremos utilizar **Session**.  \r\n  \r\nComo não precisaremos alterar o nosso **DAO**, nem o nosso **model**, iremos começar alterando diretamente os controles e depois as **views**.  \r\n  \r\n--\r\n## EfetuaLogin\r\nComo iremos alterar a funcionalidade de **login**, com certeza teremos que alterar o *controle* `EfetuaLogin`.  \r\nEstamos utilizando *Session*, então precisamos gerar o *import* apropriado:  \r\n  \r\n     import javax.servlet.http.HttpSession;\r\n  \r\nAgora, a mudança que devemos fazer é: ao invés de setar um atributo no **request** `request.setAttribute(\"usuarioBean\", u);`, devemos setar esse atributo na *session*.  \r\nPara isso, devemos encontrar dentro do método `doPost`, o seguinte trecho de código, que indica que o login foi efetuado com sucesso.  \r\n  \r\n        if (senha.equals(u.getSenha())) {\r\n            // vincula bean\r\n            request.setAttribute(\"usuarioBean\", u);\r\n\r\n            RequestDispatcher rd = null;\r\n            rd = request.getRequestDispatcher(\"/viewLogado.jsp\");\r\n            rd.forward(request, response);\r\n        }\r\n  \r\nSendo que, podemos apagar a seguinte linha, conforme dito anteriormente.  \r\n  \r\n            request.setAttribute(\"usuarioBean\", u);\r\n  \r\nE, trocar por:  \r\n  \r\n            HttpSession session = request.getSession();\r\n            session.setAttribute(\"usuario\", u);\r\n  \r\nAssim, ao invés de setar uma variável em *request*, estaremos vinculando o objeto a session.  \r\n  \r\nComo iremos precisar realizar o logout também, podemos criar um método *doGet*, dentro de *EfetuaLogin*, onde iremos retirar o atributo `usuario` da *seession*, assim que o *servlet* receber uma requisição *get*.  \r\nA assinatura do método segue o mesmo padrão do método `doPost`, sendo que, apenas temos que alterar `doPost` para `doGet`, ficando da seguinte forma:  \r\n  \r\n    @Override\r\n    protected void doGet(HttpServletRequest request, HttpServletResponse response)\r\n            throws ServletException, IOException \r\n  \r\nQuanto a implementação da funcionalidade, não existem grande dificuldades também, basta recuperarmos a session do usuário, (passando *false* como parâmetro, afim de que a session seja duplicada) e removermos todos os atributos da session, deixando a implementação da seguinte forma:  \r\n  \r\n        HttpSession session = request.getSession(false);\r\n        session.invalidate();\r\n        response.sendRedirect(\"index.jsp\");\r\n  \r\n  \r\n--\r\n## CadastraUsuario\r\nComo, ao conseguirmos cadastrar um novo usuário, nós também efetuamos login, é necessário realizar a devida alteração nesse controle também.  \r\nPara isso, basta encontrar o trecho de código que se refere ao cadastro bem sucedido de um novo usuário, dentro do método `doPost` (que é esse trecho abaixo).\r\n  \r\n        try {\r\n            UsuarioDAO uDAO = new UsuarioDAO();\r\n            uDAO.salvar(u);\r\n            request.setAttribute(\"usuarioBean\",u);\r\n            RequestDispatcher rd = null;\r\n            rd = request.getRequestDispatcher(\"/viewLogado.jsp\");\r\n            rd.forward(request, response);\r\n        }\r\n  \r\nE, novamente, alterar a seguinte linha:  \r\n  \r\n        request.setAttribute(\"usuarioBean\",u);\r\n  \r\nPor:  \r\n  \r\n            HttpSession session = request.getSession();\r\n            session.setAttribute(\"usuario\", u);\r\n  \r\nNossos *controles* que implementam a funcionalidade de login e logout já estão prontos. Agora, basta realizarmos as devidas alterações nas *views*.  \r\n  \r\n--\r\n## viewLogado\r\nAgora, vamos olhar nossa página `viewLogado` que era o local que o usuário era direcionado, assim que o login era efetuado com sucesso.  \r\nTeremos que alterar algumas coisas no menu (encontre o trecho de código abaixo).  \r\n  \r\n      <nav id=\"menu\">\r\n        <ul>\r\n            <% \r\n                Usuario objUsuarioBean = (Usuario)request.getAttribute(\"usuarioBean\");\r\n                if (objUsuarioBean!=null){\r\n                 if(objUsuarioBean.getUsuario().equals(\"adm\")){\r\n              %>\r\n            <li><a href=\"#.jsp\" class=\"active\">Autorização de usuário</a></li>\r\n            <li><a href=\"#.jsp\">Cadastro de Rotas</a></li>\r\n            <%\r\n                 }else{\r\n                     \r\n                 }\r\n                }\r\n            %>\r\n        </ul>\r\n      </nav>\r\n  \r\nComo, alteramos a forma como passamos o `Usuario` para a view, devemos alterar também a forma de recuperação, trocando a seguinte linha:  \r\n  \r\n                Usuario objUsuarioBean = (Usuario)request.getAttribute(\"usuarioBean\");\r\n  \r\npor...  \r\n  \r\n                Usuario objUsuarioBean = (Usuario)session.getAttribute(\"usuario\");\r\n  \r\nJá que, não estamos mais retornando o atributo em `request`, mas sim na `session`, e também alteramos o nome do atributo de `usuarioBean` para `usuario`.  \r\nComo, por enquanto estamos trabalhando apenas com usuários comuns do sistema, podemos alterar a seguinte linha também.  \r\n  \r\n                 if(objUsuarioBean.getUsuario().equals(\"adm\")){\r\n  \r\npor:  \r\n  \r\n                 if(objUsuarioBean.getTipo().equals(\"user\")){\r\n  \r\nTambém podemos alterar o menu:  \r\n  \r\n            <li><a href=\"#.jsp\" class=\"active\">Autorização de usuário</a></li>\r\n            <li><a href=\"#.jsp\">Cadastro de Rotas</a></li>\r\n  \r\nPor algo que realmente possamos navegar.  \r\n  \r\n            <li><a href=\"viewLogado.jsp\" class=\"active\">Inicio</a></li>\r\n            <li><a href=\"EfetuaLogin\">Sair</a></li>\r\n  \r\nNote que, como quando simplesmente chamamos o *servlet* `EfetuaLogin`, pela URL, estamos realizando um GET, não precisamos de um *form* para realizar o *logout*.  \r\n  \r\n--\r\n## Redirecionando as páginas\r\nNo nosso caso, a página `viewLogado`, já estava pronta e o mais fácil nesse caso foi alterar alguns atributos nela.  \r\nPara a página `buscaPorCidade.jsp` e as demais páginas da nossa aplicação, iremos usar a marcação de `include`.  \r\nPrimeiramente, devemos criar a nossa regra em um arquivo separado.  \r\nClique com o `botão direito` sobre *Página da Web* > *Novo* > *JSP...*  \r\n  \r\nAltere o *Nome do arquivo* para `logado` e marque a opção `Criar como um Segmento JSP`.  \r\n[<img src=\"https://raw.github.com/hugonomura/imagens-tutorial/master/img40.png\">](#)  \r\n  \r\nClique em *Finalizar*.  \r\n  \r\nApague todo o conteúdo gerado pelo *Netbeans* no arquivo, deixando-o em branco.  \r\nAgora, iremos adicionar o seguinte código:  \r\n  \r\n        <%@page import=\"model.Usuario\"%>\r\n        <% \r\n            HttpSession sessao = request.getSession();\r\n            Usuario u = (Usuario)sessao.getAttribute(\"usuario\");\r\n            if(u == null){\r\n                response.sendRedirect(\"index.jsp\");\r\n            }\r\n            %>\r\n  \r\nOnde, nós já realizamos o *import* de `Usuario` e verificamos se ele existe na sessão.  \r\n  \r\nPara que as páginas sejam redirecionadas para a página inicial quando não houver um `usuario` na sessão, basta adicionarmos a seguinte linha no inicio dos arquivos que só devem ser acessadas quando o usuário estiver logado no sistema.  \r\n  \r\n          <%@include file=\"logado.jsp\"  %>\r\n  \r\nNo nosso caso, iremos incluir essa linha no arquivo *buscaCidade.jsp*, deixando-o da seguinte forma:  \r\n  \r\n    <%@include file=\"logado.jsp\"  %>\r\n    <!DOCTYPE html>\r\n    <html>\r\n      <head>\r\n        <title>Caronas | Busca</title>\r\n        <meta charset=\"UTF-8\">\r\n        <link rel=\"stylesheet\" type=\"text/css\" href=\"estilo.css\">\r\n        <script src=\"jquery.min.js\"></script>\r\n      </head>\r\n      <body>\r\n        <header class=\"container\">\r\n          <h1 id=\"logo\"><a href=\"index.jsp\">Caronas</a></h1>\r\n          <nav id=\"menu\">\r\n            <ul>\r\n              <li><a href=\"index.jsp\" class=\"active\">Inicio</a></li>\r\n              <li><a href=\"cadastro.jsp\">Cadastro</a></li>\r\n            </ul>\r\n          </nav>\r\n        </header>\r\n        <section class=\"container\">\r\n          <article id=\"form\">\r\n            <header>\r\n              <h1>Busca</h1>\r\n            </header>\r\n              <form method=\"get\" action=\"BuscaUsuarios\">\r\n              <p><label for=\"nomeCidade\">Cidade</label><input type=\"text\" id=\"nomeCidade\" name=\"nomeCidade\"></p>\r\n              <p><input type=\"submit\" id=\"busca\"value=\"Buscar\"></p>\r\n            </form>\r\n          </article>\r\n        </section>\r\n        <footer class=\"container\">\r\n          <p>Desenvolvimento Web - UFSCar Sorocaba - 2013</p>\r\n        </footer>\r\n        <script>\r\n          $(document).ready(function(){\r\n           \r\n          });\r\n        </script>\r\n      </body>\r\n    </html>","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}